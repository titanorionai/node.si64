services:
  # --- MEMORY LAYER (CACHE & STATE) ---
  redis:
    image: redis:7-alpine
    container_name: titan-memory
    ports:
      - "127.0.0.1:6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - titan-network
    command: redis-server --appendonly yes
    restart: unless-stopped

  # --- BRAIN LAYER (DISPATCHER & API) ---
  brain:
    build:
      context: .
      dockerfile: Dockerfile.brain
    container_name: titan-brain
    ports:
      - "127.0.0.1:8000:8000"
    volumes:
      - /home/titan/TitanNetwork:/app
      - /home/titan/TitanNetwork/titan_bank.json:/app/titan_bank.json
    networks:
      - titan-network
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - SOLANA_RPC_URL=https://api.mainnet-beta.solana.com
      - LOG_LEVEL=INFO
      - TITAN_GENESIS_KEY=${TITAN_GENESIS_KEY:-TITAN_GENESIS_KEY_V1_SECURE}
    restart: unless-stopped
    depends_on:
      - redis
    healthcheck:
      test: ["CMD", "curl", "-s", "-o", "/dev/null", "-w", "%{http_code}", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  # --- ENGINE LAYER (AI INFERENCE) ---
  ollama:
    image: ollama/ollama:latest
    container_name: titan-ollama-engine
    mem_limit: 16g
    cpus: '4.0'
    volumes:
      - ollama-models:/root/.ollama
    networks:
      - titan-network
    ports:
      - "127.0.0.1:11434:11434"
    environment:
      - OLLAMA_HOST=0.0.0.0:11434
    restart: unless-stopped
    # Healthcheck disabled to avoid dependency blocks in minimal setups

  # --- WORKER CONTROLLER (THE LIMB) ---
  job-executor:
    build:
      context: .
      dockerfile: Dockerfile.worker
    container_name: titan-job-executor
    
    # Keep host network to allow sub-containers to spawn and reach services
    network_mode: "host"
    
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /home/titan/TitanNetwork:/app/workspace
      - /tmp/titan-jobs:/tmp/titan-jobs
    
    environment:
      - DISPATCHER_HOST=127.0.0.1
      - DISPATCHER_PORT=8000
      - OLLAMA_HOST=127.0.0.1:11434
      - REDIS_HOST=127.0.0.1
      - REDIS_PORT=6379
      - TITAN_CONTAINER_MODE=true
      - TITAN_GENESIS_KEY=${TITAN_GENESIS_KEY:-TITAN_GENESIS_KEY_V1_SECURE}
    
    restart: unless-stopped
    
    depends_on:
      - brain
      - redis
      - ollama

  # --- THE MOUTHPIECE (PSYCHOLOGICAL WARFARE UNIT) ---
  titan-vanguard:
    build:
      context: .
      dockerfile: Dockerfile.vanguard
    container_name: titan-vanguard-unit
    
    # [TACTICAL] Operational Resilience
    restart: unless-stopped
    networks:
      - titan-network
    
    # [HARDWARE] Resource Allocation (Prevents runaway processes)
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M

    # [SECURITY] Credential Injection
    # Loads API keys from the secure .env vault automatically
    env_file:
      - .env

    # [CONFIGURATION] Mission Parameters
    environment:
      # Internal Command & Control Uplinks
      - TITAN_BRAIN_URL=http://titan-brain:8000/api/stats
      - TITAN_OLLAMA_URL=http://titan-ollama-engine:11434/api/generate
      
      # Personality Matrix (JUGGERNAUT V5.0)
      - BOT_MODE=${BOT_MODE:-DIGITAL_JUGGERNAUT}
      - POST_INTERVAL_MIN=${POST_INTERVAL_MIN:-60}
      - POST_INTERVAL_MAX=${POST_INTERVAL_MAX:-180}
      
      # System Telemetry
      - LOG_LEVEL=INFO
      - MAX_NET_RETRIES=5

    # [HEALTH] Heartbeat Monitor (Auto-restarts if bot freezes)
    healthcheck:
      test: ["CMD-SHELL", "test -f /tmp/vanguard_heartbeat"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

    depends_on:
      ollama:
        condition: service_started

volumes:
  ollama-models:
    driver: local
  redis-data:
    driver: local

networks:
  titan-network:
    driver: bridge
